<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç»Ÿè®¡è¡¨æ ¼</title>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    button { cursor: pointer; margin-right: 10px; }
    #manualInputBtn, #showChartBtn, #sortBtn, #exportBtn, #importBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #chartContainer, #pieChartContainer {
      margin-top: 40px;
      display: none; /* åˆå§‹éšè—å›¾è¡¨å®¹å™¨ */
    }
    canvas { width: 600px !important; height: 300px !important; }
    /* ä¿è¯é¥¼çŠ¶å›¾æ¯”ä¾‹ä¸º1:1 */
    #pieChartContainer canvas {
       width: 300px !important;
       height: 300px !important;
    }
  </style>
  <!-- å¼•å…¥Chart.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ç»Ÿè®¡è¡¨æ ¼</h1>
  <table id="statsTable">
    <thead>
      <tr>
         <th>æ—¶é—´</th>
         <th>å·¥ä½œæ—¶é•¿</th>
         <th>å¨±ä¹æ—¶é•¿</th>
         <th>åˆ©æ¶¦</th>
         <th>æœ€é«˜å¾½ç« </th>
         <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="manualInputBtn">æ‰‹åŠ¨è¾“å…¥è®°å½•</button>
  <button id="showChartBtn">æ˜¾ç¤ºå›¾è¡¨</button>
  <button id="sortBtn">æ—¥æœŸæ’åº</button>
  <button id="exportBtn">è¡¨æ ¼å¯¼å‡º</button>
  <button id="importBtn">è¡¨æ ¼å¯¼å…¥</button>
  <input type="file" id="fileInput" style="display:none" accept=".csv"/>

  <div id="chartContainer">
    <canvas id="statsChart"></canvas>
  </div>

  <div id="pieChartContainer">
    <canvas id="pieChart"></canvas>
  </div>

  <script>
    // æˆå°±æ•°ç»„å®šä¹‰
    const workAchievements = [
      { threshold: 1800, label: 'å°è¯•é”‹èŠ’ï¼ˆ30minå·¥ä½œï¼‰', icon: 'ğŸ–ï¸' },
      { threshold: 3600, label: 'å§é¾™å‡ºå±±ï¼ˆ1hå·¥ä½œï¼‰', icon: 'ğŸ…' },
      { threshold: 7200, label: 'åŒè¿ï¼ä¸€æˆ˜æˆåï¼ˆ2hå·¥ä½œï¼‰', icon: 'ğŸ–ï¸' },
      { threshold: 10800, label: 'ä¸‰è¿ï¼ä¸¾ä¸–çš†æƒŠï¼ˆ3hå·¥ä½œï¼‰', icon: 'ğŸ…' },
      { threshold: 14400, label: 'å››è¿ï¼å¤©ä¸‹æ— æ•Œï¼ˆ4hå·¥ä½œï¼‰', icon: 'ğŸ–ï¸' },
      { threshold: 18000, label: 'äº”è¿ï¼è¯›å¤©ç­åœ°ï¼ˆ5hå·¥ä½œï¼‰', icon: 'ğŸ…' }
    ];
    const playAchievements = [
      { threshold: 15 * 60, label: 'ä¸€åˆ»æµèŠ³ï¼ˆ15minå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 60 * 60, label: 'æ—¶å…‰èè‹’ï¼ˆ1hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 120 * 60, label: 'å¿ƒæ—·ç¥æ€¡ï¼ˆ2hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 180 * 60, label: 'å…¶ä¹æ— ç©·ï¼ˆ3hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 240 * 60, label: 'ç•…å¿«æ·‹æ¼“ï¼ˆ4hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 300 * 60, label: 'äººé—´è‡³ä¹ï¼ˆ5hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 360 * 60, label: 'æµ®ç”ŸåŠæ—¥ï¼ˆ6hå¨±ä¹ï¼‰', icon: 'ğŸ‰' },
      { threshold: 480 * 60, label: 'å¤©äººåˆä¸€ï¼ˆ8hå¨±ä¹ï¼‰', icon: 'ğŸ‰' }
    ];
    const profitAchievements = [
      { threshold: 30 * 60, label: 'ä¸€å¿µä¹‹é—´ï¼ˆ30minåˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 60 * 60, label: 'å®é™è‡´è¿œï¼ˆ1håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 120 * 60, label: 'æ½œå¿ƒç¬ƒè¡Œï¼ˆ2håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 240 * 60, label: 'ä¸€å¿ƒä¸€æ„ï¼ˆ4håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 300 * 60, label: 'é™æ°´æµæ·±ï¼ˆ5håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 360 * 60, label: 'å¿˜æˆ‘ä¸“æ³¨ï¼ˆ6håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 420 * 60, label: 'å¦‚æ²æ˜¥é£ï¼ˆ7håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' },
      { threshold: 480 * 60, label: 'æ— æˆ‘æ— å¢ƒï¼ˆ8håˆ©æ¶¦ï¼‰', icon: 'ğŸ‰' }
    ];

    function getHighest(value, achievements) {
      let highest = null;
      achievements.forEach(ach => {
        if (value >= ach.threshold) highest = ach;
      });
      return highest ? `[${highest.label}]` : '';
    }

    function formatTime(totalSeconds) {
      totalSeconds = Math.max(0, Math.round(totalSeconds));
      let hours = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;
      return `${hours}h ${minutes}min ${seconds}s`;
    }

    function formatProfit(totalSeconds) {
      let sign = totalSeconds < 0 ? '-' : '';
      totalSeconds = Math.abs(Math.round(totalSeconds));
      let hours = Math.floor(totalSeconds / 3600);
      let minutes = Math.floor((totalSeconds % 3600) / 60);
      let seconds = totalSeconds % 60;
      return `${sign}${hours}h ${minutes}min ${seconds}s`;
    }

    function parseDateOnly(timeStr) {
      const regex = /(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/;
      const match = timeStr.match(regex);
      if (match) {
        const [_, year, month, day] = match;
        return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
      }
      return new Date();
    }

    function loadArchives() {
      return JSON.parse(localStorage.getItem('archives')) || [];
    }

    function saveArchives(archives) {
      localStorage.setItem('archives', JSON.stringify(archives));
    }

    function updateTable() {
      const archives = loadArchives();
      const tbody = document.getElementById('statsTable').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      archives.forEach((entry, index) => {
        let profit = entry.work - entry.play;
        let workBadge = getHighest(entry.work, workAchievements);
        let playBadge = getHighest(entry.play, playAchievements);
        let profitBadge = getHighest(profit, profitAchievements);
        let highestBadges = `${workBadge}${playBadge}${profitBadge}`;

        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${entry.time}</td>
           <td>${formatTime(entry.work)}</td>
           <td>${formatTime(entry.play)}</td>
           <td>${formatProfit(profit)}</td>
           <td>${highestBadges}</td>
           <td>
             <button onclick="modifyRecord(${index})">ä¿®æ”¹</button>
             <button onclick="deleteRecord(${index})">åˆ é™¤</button>
           </td>`;
        tbody.appendChild(tr);
      });
    }

    function manualInputRecord() {
      const time = prompt("è¯·è¾“å…¥æ—¶é—´ï¼ˆä¾‹å¦‚ï¼š2023å¹´8æœˆ1æ—¥ 10ç‚¹30åˆ†ï¼‰ï¼š");
      if (!time) return;
      const workInput = prompt("è¯·è¾“å…¥å·¥ä½œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š");
      const playInput = prompt("è¯·è¾“å…¥å¨±ä¹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š");
      const work = (parseFloat(workInput) || 0) * 60;
      const play = (parseFloat(playInput) || 0) * 60;
      const profit = work - play;
      const parsedDate = parseDateOnly(time);
      const archiveEntry = {
        time,
        timestamp: parsedDate.getTime(),
        work,
        play,
        profit,
        highestBadges: ''
      };
      let archives = loadArchives();
      archives.push(archiveEntry);
      saveArchives(archives);
      updateTable();
      if (chartInitialized) {
        updateChart();
        updatePieChart();
      }
    }

    document.getElementById('manualInputBtn').addEventListener('click', manualInputRecord);

    function modifyRecord(index) {
      let archives = loadArchives();
      let entry = archives[index];
      if (!entry) return;
      const newTime = prompt("ä¿®æ”¹æ—¶é—´ï¼š", entry.time) || entry.time;
      const newWork = (parseFloat(prompt("ä¿®æ”¹å·¥ä½œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š", entry.work / 60)) || (entry.work / 60)) * 60;
      const newPlay = (parseFloat(prompt("ä¿®æ”¹å¨±ä¹æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š", entry.play / 60)) || (entry.play / 60)) * 60;
      const newTimeDate = parseDateOnly(newTime);
      entry.time = newTime;
      entry.timestamp = newTimeDate.getTime();
      entry.work = newWork;
      entry.play = newPlay;
      entry.profit = newWork - newPlay;
      saveArchives(archives);
      updateTable();
      if (chartInitialized) {
        updateChart();
        updatePieChart();
      }
    }

    function deleteRecord(index) {
      let archives = loadArchives();
      if (index < 0 || index >= archives.length) return;
      if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è®°å½•å—ï¼Ÿ")) {
        archives.splice(index, 1);
        saveArchives(archives);
        updateTable();
        if (chartInitialized) {
          updateChart();
          updatePieChart();
        }
      }
    }

    function sortByDate() {
      let archives = loadArchives();
      archives.sort((a, b) => {
        let ta = parseDateOnly(a.time).getTime();
        let tb = parseDateOnly(b.time).getTime();
        return ta - tb;
      });
      saveArchives(archives);
      updateTable();
      if(chartInitialized) {
        updateChart();
        updatePieChart();
      }
    }

    document.getElementById('sortBtn').addEventListener('click', sortByDate);

    updateTable();

    // å›¾è¡¨éƒ¨åˆ†
    let statsChart;
    let chartInitialized = false;

    function groupDataByDate(archives) {
      const grouped = {};
      archives.forEach(entry => {
        const d = parseDateOnly(entry.time);
        const dateStr = d.toISOString().split('T')[0];
        if (!grouped[dateStr]) {
          grouped[dateStr] = { work: 0, play: 0, profit: 0 };
        }
        grouped[dateStr].work += entry.work;
        grouped[dateStr].play += entry.play;
        grouped[dateStr].profit += entry.profit;
      });
      return grouped;
    }

    function updateChart() {
      const archives = loadArchives();
      if (archives.length === 0) return;
      const grouped = groupDataByDate(archives);

      let latest = new Date(Math.max(...archives.map(a => parseDateOnly(a.time).getTime())));
      latest.setHours(0,0,0,0);
      const oneDayMs = 24*3600*1000;
      const dates = [];
      for (let i = 29; i >= 0; i--) {
        let d = new Date(latest.getTime() - i * oneDayMs);
        d.setDate(d.getDate() + 1);
        dates.push(d.toISOString().split('T')[0]);
      }

      const workData = [];
      const playData = [];
      const profitData = [];
      dates.forEach(date => {
        let dayData = grouped[date] || { work: 0, play: 0, profit: 0 };
        workData.push(dayData.work);
        playData.push(dayData.play);
        profitData.push(dayData.profit);
      });

      const ctx = document.getElementById('statsChart').getContext('2d');
      const chartData = {
        labels: dates,
        datasets: [
          {
            label: 'å·¥ä½œæ—¶é•¿',
            data: workData,
            backgroundColor: 'rgba(75, 192, 192, 0.5)'
          },
          {
            label: 'å¨±ä¹æ—¶é•¿',
            data: playData,
            backgroundColor: 'rgba(192, 75, 192, 0.5)'
          },
          {
            label: 'åˆ©æ¶¦',
            data: profitData,
            backgroundColor: 'rgba(192, 192, 75, 0.5)'
          }
        ]
      };
      const config = {
        type: 'bar',
        data: chartData,
        options: {
          scales: {
            x: { title: { display: true, text: 'æ—¥æœŸ' } },
            y: { title: { display: true, text: 'ç§’æ•°' } }
          }
        }
      };

      if(statsChart) { statsChart.destroy(); }
      statsChart = new Chart(ctx, config);
      chartInitialized = true;
    }

    document.getElementById('showChartBtn').addEventListener('click', () => {
      document.getElementById('chartContainer').style.display = 'block';
      updateChart();
      updatePieChart();
    });

    function exportTable() {
      const archives = loadArchives();
      if (archives.length === 0) { alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º"); return; }
      let csvContent = "\uFEFF";
      csvContent += "æ—¶é—´,å·¥ä½œæ—¶é•¿ï¼ˆç§’ï¼‰,å¨±ä¹æ—¶é•¿ï¼ˆç§’ï¼‰,åˆ©æ¶¦ï¼ˆç§’ï¼‰,æœ€é«˜å¾½ç« \n";
      archives.forEach(entry => {
        csvContent += `${entry.time},${entry.work},${entry.play},${entry.profit},${entry.highestBadges}\n`;
      });
      const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "ç»Ÿè®¡è®°å½•.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    document.getElementById('exportBtn').addEventListener('click', exportTable);

    function importTable(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        let archives = loadArchives();
        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',');
          if (cols.length < 5) continue;
          const [time, work, play, profit, highestBadges] = cols;
          const parsedDate = parseDateOnly(time);
          archives.push({
            time: time,
            timestamp: parsedDate.getTime(),
            work: parseFloat(work) || 0,
            play: parseFloat(play) || 0,
            profit: parseFloat(profit) || 0,
            highestBadges: highestBadges || ''
          });
        }
        saveArchives(archives);
        updateTable();
        if(chartInitialized) {
          updateChart();
          updatePieChart();
        }
      };
      reader.readAsText(file, 'UTF-8');
    }
    document.getElementById('importBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', importTable);

    // é¥¼çŠ¶å›¾éƒ¨åˆ†
    let pieChart;
    function updatePieChart() {
      const archives = loadArchives();
      if (archives.length === 0) return;
      const grouped = groupDataByDate(archives);

      let totalWork = 0, totalPlay = 0;
      for (let key in grouped) {
        totalWork += grouped[key].work;
        totalPlay += grouped[key].play;
      }
      const ctxPie = document.getElementById('pieChart').getContext('2d');
      const data = {
        labels: ['å·¥ä½œæ—¶é•¿', 'å¨±ä¹æ—¶é•¿'],
        datasets: [{
          data: [totalWork, totalPlay],
          backgroundColor: [
            'rgba(75, 192, 192, 0.5)',
            'rgba(192, 75, 192, 0.5)'
          ]
        }]
      };
      if(pieChart) { pieChart.destroy(); }
      pieChart = new Chart(ctxPie, {
        type: 'pie',
        data: data,
        options: {
          plugins: {
            title: {
              display: true,
              text: 'è¿‘ä¸€ä¸ªæœˆ å·¥ä½œæ—¶é•¿ä¸å¨±ä¹æ—¶é•¿æ¯”ä¾‹'
            }
          }
        }
      });
      document.getElementById('pieChartContainer').style.display = 'block';
    }
  </script>
</body>
</html>
